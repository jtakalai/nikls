<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
      integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
      crossorigin="anonymous">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nikls is kinda like scred</title>

<script>

'use strict';

var backend = "/v0/";
var acceptJson = new Headers({"Accept": "application/json"});
var sendJson = new Headers({"Content-Type": "application/json"});
var getOpts = {method: "GET", headers: acceptJson, credentials: "same-origin"};

var accountNames = [];

function space() {
    return document.createTextNode(" ");
}

function formatBalance(b) {
    var el = document.createElement("span");
    el.className = b.balance >= 0 ? "label-success" : "label-danger";
    el.className += " label";
    var amount = b.balance/100.0;
    el.textContent = b.account + " " + (amount>0 ? "+" : "") + amount;
    return el;
}

function formatTime(t) {
    function pad(n) {
	if (n<10) {
	    return "0"+n;
	}
	return ""+n;
    }
    var d = new Date(t);
    var str = d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) +
	" " + pad(d.getHours()) + ":" + pad(d.getMinutes());
    return document.createTextNode(str);
}

function transactionAction(t, action) {
    fetch(backend+'transaction/'+t.time+'/'+action, {method: "POST", credentials: "same-origin"})
    .catch(function(err) {
	console.log("ERROR", err);
	document.getElementById("status").textContent = err;
    })
    .then(function(_) {
	update();
    });
}

function cancelLink(t) {
    var a = document.createElement("a");
    var action = t.cancelled ? "uncancel" : "cancel";
    a.onclick = function() { transactionAction(t, action); };
    a.textContent = action;
    return a;
}

function formatTransaction(t) {
    var el = document.createElement(t.cancelled ? "s" : "span");
    el.appendChild(formatTime(t.time))
    el.appendChild(space());
    var balances = t.positive.concat(t.negative);
    balances.sort(function(a, b) { return b.balance - a.balance; });
    balances.forEach(function(b) {
	el.appendChild(formatBalance(b));
	el.appendChild(space());
    });
    el.appendChild(space());
    el.appendChild(cancelLink(t));
    el.appendChild(document.createElement("br"));
    el.appendChild(document.createTextNode(t.description));
    return el;
}

function update() {
    fetch(backend+'transaction', getOpts)
    .then(function(r) { return r.json(); })
    .then(function(ts) {
	var ul = document.getElementById("transactions");
	while (ul.firstChild) {
	    ul.removeChild(ul.firstChild);
	}
	console.log(ts);
	ts.reverse();
	ts.forEach(function(t) {
	    var li = document.createElement("li");
	    li.appendChild(formatTransaction(t));
	    ul.appendChild(li);
	});
    });

    fetch(backend+'balances', getOpts)
    .then(function(r) { return r.json(); })
    .then(function(bs) {
	var ul = document.getElementById("balances");
	while (ul.firstChild) {
	    ul.removeChild(ul.firstChild);
	}
	accountNames = bs.map(function(b) { return b.account; });
	bs.forEach(function(b) {
	    var li = document.createElement("li");
	    li.appendChild(formatBalance(b));
	    ul.appendChild(li);
	});
    });
}

function verifyAccounts(accounts) {
    var unknown = accounts.filter(
	function (acc) { return !accountNames.includes(acc); });
    if (unknown.length === 0) {
	return true;
    }
    return confirm("Unknown users: "+unknown+"\n"+
		   "Do you want to create them?");
}

function serializeBalances(obj) {
    return Object.keys(obj).map(function(k) {
	return {account: k,
		balance: obj[k]}});
}

function add() {
    // XXX move to backend?
    var cents = Math.round(document.getElementById("sum").value*100);
    console.log("cents", cents);
    var description = document.getElementById("description").value;
    var payer = document.getElementById("payer").value;
    var shared = document.getElementById("shared").value.split(" ");

    if (!verifyAccounts(shared.concat([payer]))) {
	return false;
    }

    var positive = {};
    positive[payer] = cents;

    var part = Math.round(cents / shared.length);
    var negative = {};
    shared.forEach(function(s) {
	negative[s] = (negative[s] || 0) - part;
	cents -= part;
    });
    // allocate the rest to an arbitrary person
    negative[shared[0]] -= cents;

    console.log("balances", positive, negative);

    var transaction = {time: (new Date()).getTime(),
		       description: description,
		       cancelled: false,
		       positive: serializeBalances(positive),
		       negative: serializeBalances(negative)}

    console.log("transaction", transaction);

    fetch(backend+'transaction', {method: "POST",
				  credentials: "same-origin",
				  headers: sendJson,
				  body: JSON.stringify(transaction)})
    .then(function(r) {
	return r.text();
    })
    .then(function(status) {
	console.log("STATUS", status);
	document.getElementById("status").textContent = status;
	update();
    })
    .catch(function(err) {
	console.log("ERROR", err);
	document.getElementById("status").textContent = err;
    });

    return false;
}

update()

</script>

</head>

<body>
<div class="container">
  <h1>Add transaction</h1>
  <form class="form-horizontal">
    <div class="form-group">
      <div class="col-sm-12">
	<label for="description" class="control-label">Description</label>
	<input class="form-control" type="text" id="description"
	       placeholder="Description" />
      </div>
    </div>
    <div class="form-group">
      <div class="col-sm-2">
	<label for="sum" class="control-label">Sum</label>
	<input class="form-control" type="text" pattern="[0-9.]*" id="sum"
	       placeholder="0.00" />
      </div>
      <div class="col-sm-2">
	<label for="payer" class="control-label">Payer</label>
	<input class="form-control" type="text" id="payer"
	       placeholder="name" />
      </div>
      <div class="col-sm-8">
	<label for="shared" class="control-label">Shared by</label>
	<input class="form-control" type="text" id="shared"
	       placeholder="name1 name2 name3"/>
      </div>
    </div>
    <div class="form-group">
      <div class="col-sm-12">
	<button onclick="return add()" class="col-sm-12 btn btn-success btn-block">Add</button>
      </div>
    </div>
  </form>
  <p>Status: <span id="status"></span></p>

  <h1>Balances:</h1>
  <ul id="balances"></ul>

  <h1>All transactions:</h1>
  <ul id="transactions"></ul>
</div>
</body>
</html>
