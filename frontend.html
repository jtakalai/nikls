<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Nikls is kinda like scred</title>

<script>

var backend = "http://localhost:8081/v0/";
var acceptJson = new Headers({"Accept": "application/json"});
var sendJson = new Headers({"Content-Type": "application/json"});
var getOpts = {method: "GET", headers: acceptJson};

function formatBalance(b) {
    return b.account + ":" + (b.balance/100.0);
}

function formatTransaction(t) {
    var desc = new Date(t.time).toISOString() + " " + t.description;
    t.balances.forEach(function(b) {
	desc += " "+formatBalance(b);
    });
    return desc;
}

function update() {
    fetch(backend+'transaction', getOpts)
    .then(function(r) { return r.json(); })
    .then(function(ts) {
	var ul = document.getElementById("transactions");
	while (ul.firstChild) {
	    ul.removeChild(ul.firstChild);
	}
	console.log(ts);
	ts.forEach(function(t) {
	    var li = document.createElement("li");
	    li.appendChild(document.createTextNode(formatTransaction(t)));
	    ul.appendChild(li);
	});
    });

    fetch(backend+'balances', getOpts)
    .then(function(r) { return r.json(); })
    .then(function(bs) {
	var ul = document.getElementById("balances");
	while (ul.firstChild) {
	    ul.removeChild(ul.firstChild);
	}
	bs.forEach(function(b) {
	    var li = document.createElement("li");
	    li.appendChild(document.createTextNode(formatBalance(b)));
	    ul.appendChild(li);
	});
    });
}

function add() {
    // XXX move to backend?
    var cents = Math.round(document.getElementById("sum").value*100);
    console.log("cents", cents);
    var description = document.getElementById("description").value;
    var payer = document.getElementById("payer").value;
    var shared = document.getElementById("shared").value.split(" ");

    var part = Math.round(cents / shared.length);

    balances = {}
    balances[payer] = cents
    shared.forEach(function(s) {
	balances[s] = (balances[s] || 0) - part;
	cents -= part;
    });
    // allocate the rest to an arbitrary person
    balances[shared[0]] -= cents;

    console.log("balances", balances);

    transaction = {time: (new Date()).getTime(),
		   description: description,
		   balances: []}
    Object.keys(balances).forEach(function(p) {
	transaction.balances.push({account: p, balance: balances[p]});
    });

    console.log("transaction", transaction);

    fetch(backend+'transaction', {method: "POST",
				  headers: sendJson,
				  body: JSON.stringify(transaction)})
    .then(function(r) {
	return r.text();
    })
    .then(function(status) {
	console.log("STATUS", status);
	document.getElementById("status").textContent = status;
	update();
    })
    .catch(function(err) {
	console.log("ERROR", err);
	document.getElementById("status").textContent = err;
    });
}

update()

</script>

</head>

<body>

  <h1>Add transaction</h1>
  <input type="text" id="description" placeholder="Description" /> <br/>
  <input type="number" id="sum" placeholder="0.0" /> Sum <br/>
  <input type="text" id="payer" placeholder="name" /> Payer <br />
  <input type="text" id="shared" placeholder="name1 name2 name3" />
  Shared by <br />
  <button onclick="add()">Add</button>
  <p>Status: <span id="status"></span></p>

  <h1>Balances:</h1>
  <ul id="balances"></ul>

  <h1>All transactions:</h1>
  <ul id="transactions"></ul>

</body>
</html>
