<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
      integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
      crossorigin="anonymous">
<title>Nikls is kinda like scred</title>

<script>

'use strict';

var backend = "/v0/";
var acceptJson = new Headers({"Accept": "application/json"});
var sendJson = new Headers({"Content-Type": "application/json"});
var getOpts = {method: "GET", headers: acceptJson};

function space() {
    return document.createTextNode(" ");
}

function formatBalance(b) {
    var el = document.createElement("span");
    el.className = b.balance > 0 ? "label-success" : "label-danger";
    el.className += " label";
    el.textContent = b.account + " " + (b.balance/100.0);
    return el;
}

function formatTime(t) {
    return document.createTextNode(new Date(t).toISOString());
}

function formatTransaction(t) {
    var el = document.createElement("span");
    el.appendChild(formatTime(t.time))
    el.appendChild(space());
    var balances = t.positive.concat(t.negative);
    balances.sort(function(a, b) { return b.balance - a.balance; });
    balances.forEach(function(b) {
	el.appendChild(formatBalance(b));
	el.appendChild(space());
    });
    el.appendChild(document.createElement("br"));
    el.appendChild(document.createTextNode(t.description));
    return el;
}

function update() {
    fetch(backend+'transaction', getOpts)
    .then(function(r) { return r.json(); })
    .then(function(ts) {
	var ul = document.getElementById("transactions");
	while (ul.firstChild) {
	    ul.removeChild(ul.firstChild);
	}
	console.log(ts);
	ts.forEach(function(t) {
	    var li = document.createElement("li");
	    li.appendChild(formatTransaction(t));
	    ul.appendChild(li);
	});
    });

    fetch(backend+'balances', getOpts)
    .then(function(r) { return r.json(); })
    .then(function(bs) {
	var ul = document.getElementById("balances");
	while (ul.firstChild) {
	    ul.removeChild(ul.firstChild);
	}
	bs.forEach(function(b) {
	    var li = document.createElement("li");
	    li.appendChild(formatBalance(b));
	    ul.appendChild(li);
	});
    });
}

function serializeBalances(obj) {
    return Object.keys(obj).map(function(k) {
	return {account: k,
		balance: obj[k]}});
}

function add() {
    // XXX move to backend?
    var cents = Math.round(document.getElementById("sum").value*100);
    console.log("cents", cents);
    var description = document.getElementById("description").value;
    var payer = document.getElementById("payer").value;
    var shared = document.getElementById("shared").value.split(" ");

    var positive = {};
    positive[payer] = cents;
    
    var part = Math.round(cents / shared.length);
    var negative = {};
    shared.forEach(function(s) {
	negative[s] = (negative[s] || 0) - part;
	cents -= part;
    });
    // allocate the rest to an arbitrary person
    negative[shared[0]] -= cents;

    console.log("balances", positive, negative);

    var transaction = {time: (new Date()).getTime(),
		       description: description,
		       positive: serializeBalances(positive),
		       negative: serializeBalances(negative)}
    
    console.log("transaction", transaction);

    fetch(backend+'transaction', {method: "POST",
				  headers: sendJson,
				  body: JSON.stringify(transaction)})
    .then(function(r) {
	return r.text();
    })
    .then(function(status) {
	console.log("STATUS", status);
	document.getElementById("status").textContent = status;
	update();
    })
    .catch(function(err) {
	console.log("ERROR", err);
	document.getElementById("status").textContent = err;
    });
}

update()

</script>

</head>

<body>
<div class="container">
  <h1>Add transaction</h1>
  <input type="text" id="description" placeholder="Description" /> <br/>
  <input type="number" id="sum" placeholder="0.0" /> Sum <br/>
  <input type="text" id="payer" placeholder="name" /> Payer <br />
  <input type="text" id="shared" placeholder="name1 name2 name3" />
  Shared by <br />
  <button onclick="add()" class="btn btn-primary">Add</button>
  <p>Status: <span id="status"></span></p>

  <h1>Balances:</h1>
  <ul id="balances"></ul>

  <h1>All transactions:</h1>
  <ul id="transactions"></ul>
</div>
</body>
</html>
